version: 2

# Variables
load_hatch_rate: &load_hatch_rate
    HATCH_RATE: 3

load_num_users: &load_num_users
    NUM_USERS: 1000

load_run_time: &load_run_time
    RUN_TIME: 5m

# Machines configs
machine_python3_clean: &machine_python3_clean
  docker:
    - image: circleci/python:3.8.0

machine_python3_node: &machine_python3_node
  docker:
    - image: circleci/python:3.8.0-node

machine_python3_node_browsers: &machine_python3_node_browsers
  docker:
    - image: circleci/python:3.8.0-node-browsers

# Individual (shared) steps.
step_checkout_repo: &step_checkout_repo
  checkout

step_install_requirements_for_smoke_tests: &step_install_requirements_for_smoke_tests
  run:
    name: Create virtualenv and install dependencies
    command: |
      python3 -m venv venv
      . venv/bin/activate
      pip install --quiet --upgrade pip
      pip install --quiet -r requirements_smoke.txt

step_install_requirements_for_functional_tests: &step_install_requirements_for_functional_tests
  run:
    name: Create virtualenv and install dependencies
    command: |
      python3 -m venv venv
      . venv/bin/activate
      pip install --quiet --upgrade pip
      pip install --quiet -r requirements_functional.txt
      sudo npm install -g junit-merge@2.0.0

step_install_requirements_for_parallel_browser_tests: &step_install_requirements_for_parallel_browser_tests
  run:
    name: Create virtualenv and install dependencies
    when: always
    command: |
      python3 -m venv venv
      . venv/bin/activate
      pip install --quiet --upgrade pip
      pip install --quiet -r requirements_browser.txt

step_install_requirements_for_periodic_tasks: &step_install_requirements_for_periodic_tasks
  run:
    name: Create virtualenv and install dependencies
    command: |
      python3 -m venv venv
      . venv/bin/activate
      pip install --upgrade pip
      pip install -q -r requirements_periodic_tasks.txt

step_install_allure_cli: &step_install_allure_cli
  run:
    name: Install Allure command line tool
    when: always
    command: |
      wget https://github.com/allure-framework/allure2/releases/download/2.13.1/allure-commandline-2.13.1.zip -O allure.zip
      unzip -q allure.zip
      find . -maxdepth 1 -type d -name "allure*" -exec mv {} allure \;

step_install_moxci: &step_install_moxci
  run:
    name: Install moxci to send CircleCI notifacations to Slack
    when: always
    command: |
      sudo npm install -g moxci@0.1.3

step_save_test_related_env_vars: &step_save_test_related_env_vars
  run:
    name: Saving environment variables that control test execution
    when: always
    command: |
      . venv/bin/activate
      echo "Saving environment variables that control test execution"
      ./save_test_related_env_vars.py

step_make_allure_report: &step_make_allure_report
  run:
    name: Generate Allure report
    when: always
    command: |
      export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))
      export PATH=$PATH:$HOME/bin:$PATH:$JAVA_HOME/bin:./allure/bin
      make report

step_update_allure_result_files_generated_by_browser_tests: &step_update_allure_result_files_generated_by_browser_tests
  run:
    name: Update Allure result files generated by Browser tests
    when: always
    command: |
      set -e
      mv tests/browser/results* .
      ls -lad results*
      make results_browser

step_update_allure_result_files_generated_by_functional_tests: &step_update_allure_result_files_generated_by_functional_tests
  run:
    name: Update Allure result files generated by Functional tests
    when: always
    command: |
      set -e
      ls -lad results*
      make results_functional

step_install_junit_merge: &step_install_junit_merge
  run:
    name: Install an npm package to merge JUnit XML report files
    when: always
    command: |
      sudo npm install -g junit-merge@2.0.0

step_prepare_list_of_scenarios_to_run_by_parallel_browser_tests: &step_prepare_list_of_scenarios_to_run_by_parallel_browser_tests
  run:
    name: Prepare a list of scenarios to run
    command: |
      . venv/bin/activate
      python ./env_vars/env_writer.py --env=${TEST_ENV} --config=./env_vars/env.json
      source ./env_vars/.env_with_export
      export PATH=$PATH:$HOME/bin
      if [ $(( ${CIRCLE_NODE_INDEX} % 2 )) = 0 ];
      then
          export BROWSER="chrome";
      else
          export BROWSER="firefox";
      fi
      cd tests/browser
      PYTHONPATH=. behave \
        --dry-run \
        --no-source \
        --no-summary \
        --no-snippets \
        --no-skipped \
        --tags=~@wip \
        --tags=~@fixme \
        --tags=~@skip \
        --tags=~@eu-exit \
        ${TAGS} \
        --format=mini \
        features/ \
        | grep -v "Supplied path\|Trying base directory" > scenario_titles.txt

step_install_requirements_for_load_tests: &step_install_requirements_for_load_tests
  run:
    name: Create virtualenv and install dependencies
    command: |
      python3 -m venv venv
      . venv/bin/activate
      pip install --quiet --upgrade pip
      pip install --quiet -r requirements_load.txt

step_cache_smoke_tests_requirements: &step_cache_smoke_tests_requirements
  save_cache:
    key: smoke-tests-dependency-cache-{{ .Revision }}
    paths:
      - ~/directory-tests

step_cache_functional_tests_requirements: &step_cache_functional_tests_requirements
  save_cache:
    key: functional-tests-dependency-cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}
    paths:
      - ~/directory-tests

step_cache_browser_tests_requirements: &step_cache_browser_tests_requirements
  save_cache:
    key: browser-tests-dependency-cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}
    paths:
      - ~/directory-tests

step_cache_load_tests_requirements: &step_cache_load_tests_requirements
  save_cache:
    key: load-tests-dependency-cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}
    paths:
    - ~/directory-tests

step_cache_periodic_tasks_requirements: &step_cache_periodic_tasks_requirements
  save_cache:
    key: periodic-tasks-dependency-cache-{{ .Revision }}
    paths:
      - ~/directory-tests

step_restore_cached_smoke_tests_requirements: &step_restore_cached_smoke_tests_requirements
  restore_cache:
    keys:
      - smoke-tests-dependency-cache-{{ .Revision }}

step_restore_cached_browser_tests_requirements: &step_restore_cached_browser_tests_requirements
  restore_cache:
    keys:
      - browser-tests-dependency-cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}

step_restore_cached_functional_tests_requirements: &step_restore_cached_functional_tests_requirements
  restore_cache:
    keys:
      - functional-tests-dependency-cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}

step_restore_cached_load_tests_requirements: &step_restore_cached_load_tests_requirements
  restore_cache:
    keys:
    - load-tests-dependency-cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}

step_restore_cached_periodic_tasks_requirements: &step_restore_cached_periodic_tasks_requirements
  restore_cache:
    key: periodic-tasks-dependency-cache-{{ .Revision }}

step_run_smoke_tests: &step_run_smoke_tests
  run:
    name: Run smoke tests
    command: |
      . venv/bin/activate
      python ./env_vars/env_writer.py --env=${TEST_ENV} --config=./env_vars/env.json
      source ./env_vars/.env_with_export
      PYTEST_ARGS=${PYTEST_ARGS} make smoke_tests

step_run_functional_tests: &step_run_functional_tests
  run:
    name: Run functional tests
    command: |
      python3 -m venv venv
      . venv/bin/activate
      python ./env_vars/env_writer.py --env=${TEST_ENV} --config=./env_vars/env.json
      source ./env_vars/.env_with_export;
      export PATH=$PATH:$HOME/bin
      FEATURE_DIR=${FEATURE_DIR} TAGS="${TAGS}" make functional_tests_feature_dir

step_delete_test_data: &step_delete_test_data
  run:
    name: Delete form submissions, SSO accounts & companies created by automated tests
    when: always
    command: |
      . venv/bin/activate
      python ./env_vars/env_writer.py --env=${TEST_ENV} --config=./env_vars/env.json
      source ./env_vars/.env_with_export;
      export PATH=$PATH:$HOME/bin
      ./delete_test_data.py

step_run_browser_tests_in_parallel: &step_run_browser_tests_in_parallel
  run:
    name: Run browser tests in parallel
    command: |
      . venv/bin/activate
      source ./env_vars/.env_with_export
      export PATH=$PATH:$HOME/bin
      if [ $(( ${CIRCLE_NODE_INDEX} % 2 )) = 0 ];
      then
          export BROWSER="chrome";
          google-chrome --version;
      else
          export BROWSER="firefox";
          firefox --version;
          export TAGS="${TAGS} --tags=~@skip-in-firefox"
      fi

      cd tests/browser
      echo "Found `wc -l < scenario_titles.txt` scenarios to run"
      # cat scenario_titles.txt | circleci tests split > /tmp/tests-to-run
      # calculate number of lines after which list of scenarios will be split
      SPLIT_AFTER_LINES=$(( $(wc -l < scenario_titles.txt) / $((${CIRCLE_NODE_TOTAL} / 2)) ))
      # split list of scenarios into equal parts (equal to half on number of nodes)
      # as half of nodes run tests in Chrome & the other half in Firefox
      split -d --suffix-length=1 --lines ${SPLIT_AFTER_LINES} scenario_titles.txt tests-to-run

      SPLIT_FILE_SUFFIX=$(( ${CIRCLE_NODE_INDEX} / 2 ))

      echo "Current instance of ${BROWSER} is going to run `cat tests-to-run${SPLIT_FILE_SUFFIX} | wc -l` scenarios:"
      cat tests-to-run${SPLIT_FILE_SUFFIX}

      cat tests-to-run${SPLIT_FILE_SUFFIX} | while IFS=$'\r' read -r title ; do
        echo -e "\n\n${BROWSER} run:    ${title}"
        PYTHONPATH=. \
        LOG_FILE="reports/behave_${BROWSER}_${CIRCLE_NODE_INDEX}.log" \
        timeout --verbose --preserve-status --kill-after=5s 5m \
        behave features/ \
        --format=allure_behave.formatter:AllureFormatter \
        --define AllureFormatter.issue_pattern=${BUG_TRACKER_URL_PATTERN} \
        --define AllureFormatter.link_pattern=${BUG_TRACKER_URL_PATTERN} \
        --outfile=results_${BROWSER}_${CIRCLE_NODE_INDEX}/ \
        --no-skipped \
        --no-source \
        --no-summary \
        --junit \
        --junit-directory=./junit_reports_${BROWSER}_${CIRCLE_NODE_INDEX}/ \
        --tags=~@wip \
        --tags=~@fixme \
        --tags=~@skip \
        --tags=~@eu-exit \
        ${TAGS} \
        --name "${title}" && {
          echo "${BROWSER} passed: ${title}"
        } || {
          echo "${BROWSER} failed: ${title}"
        }
      done
      echo "Found `ls -la results_${BROWSER}_${CIRCLE_NODE_INDEX}/*.json | wc -l` JSON Allure result files in results_${BROWSER}_${CIRCLE_NODE_INDEX}/"
      echo "Found `ls -la junit_reports_${BROWSER}_${CIRCLE_NODE_INDEX}/*.xml | wc -l` JUnit XML result files in junit_reports_${BROWSER}_${CIRCLE_NODE_INDEX}/"

      echo "Saving environment variables that control test execution"
      ../../save_test_related_env_vars.py


step_run_load_tests: &step_run_load_tests
  run:
    name: Run load tests
    command: |
      . venv/bin/activate
      python ./env_vars/env_writer.py --env=${TEST_ENV} --config=./env_vars/env.json
      source ./env_vars/.env_with_export;
      NUM_USERS=${NUM_USERS} HATCH_RATE=${HATCH_RATE} RUN_TIME=${RUN_TIME} make load_test_${SERVICE}

step_run_test_cms_pages_return_200: &step_run_test_cms_pages_return_200
  run:
    name: Run CMS Checker
    command: |
      . venv/bin/activate
      make test_cms_pages_return_200

step_generate_cms_page_status_report: &step_generate_cms_page_status_report
  run:
    name: Generate CMS Page Status report
    command: |
      . venv/bin/activate
      make cms_page_status_report

step_run_content_diff: &step_run_content_diff
  run:
    name: Run Content Diff tests
    command: |
      . venv/bin/activate
      SERVICE=${SERVICE} ENVS_TO_COMPARE=${ENVS_TO_COMPARE} make compare_content

step_run_dead_links_checker: &step_run_dead_links_checker
  run:
    name: Run Dead Links Checker script
    command: |
      . venv/bin/activate
      python ./env_vars/env_writer.py --env=${TEST_ENV} --config=./env_vars/env_dead_link_checker.json
      source ./env_vars/.env_with_export;
      TEST_ENV=${TEST_ENV} make dead_links_check
      make dead_links_list > ./reports/dead_links_report.txt

step_run_geckoboard_updater: &step_run_geckoboard_updater
  run:
    name: Run Geckoboard Updater script
    command: |
      . venv/bin/activate
      make geckoboard_updater

# this step requires Java 8+ to work.
step_merge_junit_xml_reports_from_periodic_tasks: &step_merge_junit_xml_reports_from_periodic_tasks
  run:
    name: Merge JUnit XML reports
    when: always
    command: |
      python3 -m venv venv
      . venv/bin/activate
      cd ./reports
      junit-merge *.xml -o merged.xml
      ls *.xml | grep -v merged.xml | xargs rm
      cd ../
      ./print_error_summary.py --report ./reports/merged.xml

# this step requires Java 8+ to work.
step_merge_junit_xml_reports_from_functional_tests: &step_merge_junit_xml_reports_from_functional_tests
  run:
    name: Merge JUnit XML reports & print errors summary
    when: always
    command: |
      python3 -m venv venv
      . venv/bin/activate
      cd ./tests/functional/reports
      junit-merge *.xml -o merged.xml
      ls *.xml | grep -v merged.xml | xargs rm
      cd ../../../
      ./print_error_summary.py --report ./tests/functional/reports/merged.xml

# this step requires Java 8+ to work.
step_merge_junit_xml_reports_from_parallel_browser_tests: &step_merge_junit_xml_reports_from_parallel_browser_tests
  run:
    name: Merge JUnit XML reports & print errors summary
    when: always
    command: |
      python3 -m venv venv
      . venv/bin/activate
      pip install --quiet --upgrade pip
      cd ./tests/browser/
      mkdir junit_report
      mv junit_reports_* junit_report/
      ls -la junit_report/
      junit-merge --recursive --dir junit_report/ --out ./junit_report/merged.xml
      rm -fr junit_report/junit_reports_*
      cd ../../
      ./print_error_summary.py --report ./tests/browser/junit_report/merged.xml

step_persist_fas_results: &step_persist_fas_results
  persist_to_workspace:
    root: .
    paths:
      - results_fas

step_persist_sso_results: &step_persist_sso_results
  persist_to_workspace:
    root: .
    paths:
      - results_sso

step_persist_profile_results: &step_persist_profile_results
  persist_to_workspace:
    root: .
    paths:
      - results_profile

step_persist_international_results: &step_persist_international_results
  persist_to_workspace:
    root: .
    paths:
      - results_international

# Lists of steps
steps_setup_env_for_smoke_tests: &steps_setup_env_for_smoke_tests
  steps:
    - *step_checkout_repo
    - *step_install_requirements_for_smoke_tests
    - *step_cache_smoke_tests_requirements

steps_setup_env_for_functional_tests: &steps_setup_env_for_functional_tests
  steps:
    - *step_checkout_repo
    - *step_install_requirements_for_functional_tests
    - *step_cache_functional_tests_requirements

steps_setup_env_for_parallel_browser_tests_using_circleci: &steps_setup_env_for_parallel_browser_tests_using_circleci
  steps:
    - *step_checkout_repo
    - *step_install_requirements_for_parallel_browser_tests
    - *step_cache_browser_tests_requirements

steps_setup_env_for_load_tests: &steps_setup_env_for_load_tests
  steps:
  - *step_checkout_repo
  - *step_install_requirements_for_load_tests
  - *step_cache_load_tests_requirements

steps_smoke_tests: &steps_smoke_tests
  steps:
    - *step_restore_cached_smoke_tests_requirements
    - *step_run_smoke_tests
    - *step_install_moxci
    - *step_install_allure_cli
    - *step_save_test_related_env_vars
    - *step_make_allure_report
    - store_test_results:
        path: ./reports
    - store_artifacts:
        path: ./reports
    - store_artifacts:
        path: ./allure_report
        destination: allure_report
    - run:
        name: Push Allure report link to Slack with moxci
        when: always
        command: |
          set -e
          export CIRCLE_PULL_REQUEST="${CIRCLE_PULL_REQUEST:-none}"
          export WORKFLOW_LINK="https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
          export summary="$(./parse_test_summary_json.py allure_report/widgets/summary.json)"
          moxci allure_report/index.html --slack_message "The latest report from SMOKE tests ran against `awk '/Environment/{print toupper($3)}' ./results/environment.properties`. ${summary}. (workflow → ${WORKFLOW_LINK})"

steps_merge_browser_allure_results_and_generate_report_and_send_link_to_slack: &steps_merge_browser_allure_results_and_generate_report_and_send_link_to_slack
  steps:
    - checkout
    - attach_workspace:
        at: ./
    - *step_install_moxci
    - *step_install_allure_cli
    - *step_update_allure_result_files_generated_by_browser_tests
    - *step_make_allure_report
    - store_artifacts:
        path: ./allure_report/
        destination: allure_report
    - run:
        name: Push Allure report link to Slack with moxci
        when: always
        command: |
          set -e
          export CIRCLE_PULL_REQUEST="${CIRCLE_PULL_REQUEST:-none}"
          export WORKFLOW_LINK="https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
          export summary="$(./parse_test_summary_json.py allure_report/widgets/summary.json)"
          moxci allure_report/index.html --slack_message "The latest report from BROWSER tests ran against `awk '/Environment/{print toupper($3)}' ./results/environment.properties`. ${summary}. (workflow → ${WORKFLOW_LINK})"

steps_generate_allure_report_from_functional_tests_and_send_link_to_slack: &steps_generate_allure_report_from_functional_tests_and_send_link_to_slack
  steps:
    - checkout
    - attach_workspace:
        at: ./
    - *step_install_moxci
    - *step_install_allure_cli
    - *step_update_allure_result_files_generated_by_functional_tests
    - *step_make_allure_report
    - store_artifacts:
        path: ./allure_report/
        destination: allure_report
    - run:
        name: Push Allure report link to Slack with moxci
        when: always
        command: |
          set -e
          export CIRCLE_PULL_REQUEST="${CIRCLE_PULL_REQUEST:-none}"
          export WORKFLOW_LINK="https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
          export summary="$(./parse_test_summary_json.py allure_report/widgets/summary.json)"
          moxci allure_report/index.html --slack_message "The latest report from FUNCTIONAL tests ran against `awk '/Environment/{print toupper($3)}' ./results/environment.properties`. ${summary}. (workflow → ${WORKFLOW_LINK})"

steps_delete_test_data: &steps_delete_test_data
  steps:
    - *step_restore_cached_functional_tests_requirements
    - *step_delete_test_data

steps_functional_tests_and_persist_fas_results: &steps_functional_tests_and_persist_fas_results
  steps:
    - *step_restore_cached_functional_tests_requirements
    - *step_run_functional_tests
    - *step_save_test_related_env_vars
    - *step_install_junit_merge
    - *step_merge_junit_xml_reports_from_functional_tests
    - store_test_results:
        path: ./tests/functional/reports
    - store_artifacts:
        path: ./tests/functional/reports
    - *step_persist_fas_results

steps_functional_tests_and_persist_sso_results: &steps_functional_tests_and_persist_sso_results
  steps:
    - *step_restore_cached_functional_tests_requirements
    - *step_run_functional_tests
    - *step_save_test_related_env_vars
    - *step_install_junit_merge
    - *step_merge_junit_xml_reports_from_functional_tests
    - store_test_results:
        path: ./tests/functional/reports
    - store_artifacts:
        path: ./tests/functional/reports
    - *step_persist_sso_results

steps_functional_tests_and_persist_profile_results: &steps_functional_tests_and_persist_profile_results
  steps:
    - *step_restore_cached_functional_tests_requirements
    - *step_run_functional_tests
    - *step_save_test_related_env_vars
    - *step_install_junit_merge
    - *step_merge_junit_xml_reports_from_functional_tests
    - store_test_results:
        path: ./tests/functional/reports
    - store_artifacts:
        path: ./tests/functional/reports
    - *step_persist_profile_results

steps_functional_tests_and_persist_international_results: &steps_functional_tests_and_persist_international_results
  steps:
    - *step_restore_cached_functional_tests_requirements
    - *step_run_functional_tests
    - *step_save_test_related_env_vars
    - *step_install_junit_merge
    - *step_merge_junit_xml_reports_from_functional_tests
    - store_test_results:
        path: ./tests/functional/reports
    - store_artifacts:
        path: ./tests/functional/reports
    - *step_persist_international_results

steps_run_parallel_browser_tests: &steps_run_parallel_browser_tests
  steps:
    - *step_restore_cached_browser_tests_requirements
    - *step_prepare_list_of_scenarios_to_run_by_parallel_browser_tests
    - *step_run_browser_tests_in_parallel
    - persist_to_workspace:
        root: .
        paths:
          - .

steps_run_load_tests: &steps_run_load_tests
  steps:
  - *step_restore_cached_load_tests_requirements
  - *step_run_load_tests
  - store_artifacts:
      path: ./reports

steps_setup_env_for_periodic_tasks: &steps_setup_env_for_periodic_tasks
  steps:
    - *step_checkout_repo
    - *step_install_requirements_for_periodic_tasks
    - *step_cache_periodic_tasks_requirements

steps_run_test_cms_pages_return_200: &steps_run_test_cms_pages_return_200
  steps:
    - *step_restore_cached_periodic_tasks_requirements
    - *step_run_test_cms_pages_return_200
    - store_test_results:
        path: ./reports
    - store_artifacts:
        path: ./reports

steps_generate_cms_page_status_report: &steps_generate_cms_page_status_report
  steps:
    - *step_restore_cached_periodic_tasks_requirements
    - *step_generate_cms_page_status_report
    - store_test_results:
        path: ./reports
    - store_artifacts:
        path: ./reports

steps_content_diff: &steps_content_diff
  steps:
    - *step_restore_cached_periodic_tasks_requirements
    - *step_run_content_diff
    - store_test_results:
        path: ./reports
    - store_artifacts:
        path: ./reports

steps_dead_links_checker: &steps_dead_links_checker
  steps:
    - *step_restore_cached_periodic_tasks_requirements
    - *step_run_dead_links_checker
    - store_test_results:
        path: ./reports
    - store_artifacts:
        path: ./reports

steps_geckoboard_updater: &steps_geckoboard_updater
  steps:
    - *step_restore_cached_periodic_tasks_requirements
    - *step_run_geckoboard_updater


jobs:
  setup_env_for_smoke_tests:
    working_directory: ~/directory-tests
    <<: [
    *machine_python3_node_browsers,
    *steps_setup_env_for_smoke_tests,
    ]

  setup_env_for_functional_tests:
    working_directory: ~/directory-tests
    <<: [
    *machine_python3_node_browsers,
    *steps_setup_env_for_functional_tests,
    ]

  setup_env_for_load_tests:
    working_directory: ~/directory-tests
    <<: [
    *machine_python3_node,
    *steps_setup_env_for_load_tests,
    ]

  setup_env_for_parallel_browser_tests_using_circleci:
    working_directory: ~/directory-tests
    <<: [
    *machine_python3_node_browsers,
    *steps_setup_env_for_parallel_browser_tests_using_circleci,
    ]

  smoke_tests_dev:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "dev"
      PYTEST_ARGS: '-m "not stage and not uat and not prod"'
    <<: [
    *machine_python3_node_browsers,
    *steps_smoke_tests,
    ]

  smoke_tests_stage:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "stage"
      PYTEST_ARGS: "-m 'not dev and not uat and not prod'"
    <<: [
    *machine_python3_node_browsers,
    *steps_smoke_tests,
    ]

  smoke_tests_uat:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "uat"
      PYTEST_ARGS: "-m 'not dev and not stage and not prod'"
    <<: [
    *machine_python3_node_browsers,
    *steps_smoke_tests,
    ]

  func_fas_test_dev:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "dev"
      FEATURE_DIR: "fas"
      TAGS: "--tags=~@stage-only --tags=~@uat-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_fas_results,
    ]

  func_sso_test_dev:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "dev"
      FEATURE_DIR: "sso"
      TAGS: "--tags=~@stage-only --tags=~@uat-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_sso_results,
    ]

  func_profile_test_dev:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "dev"
      FEATURE_DIR: "profile"
      TAGS: "--tags=~@stage-only --tags=~@uat-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_profile_results,
    ]

  func_international_test_dev:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "dev"
      FEATURE_DIR: "international"
      TAGS: "--tags=~@stage-only --tags=~@uat-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_international_results,
    ]

  func_fas_test_stage:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "stage"
      FEATURE_DIR: "fas"
      TAGS: "--tags=~@dev-only --tags=~@uat-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_fas_results,
    ]

  func_sso_test_stage:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "stage"
      FEATURE_DIR: "sso"
      TAGS: "--tags=~@dev-only --tags=~@uat-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_sso_results,
    ]

  func_profile_test_stage:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "stage"
      FEATURE_DIR: "profile"
      TAGS: "--tags=~@dev-only --tags=~@uat-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_profile_results,
    ]

  func_international_test_stage:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "stage"
      FEATURE_DIR: "international"
      TAGS: "--tags=~@dev-only --tags=~@uat-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_international_results,
    ]

  func_fas_test_uat:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "uat"
      FEATURE_DIR: "fas"
      TAGS: "--tags=~@stage-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_fas_results,
    ]

  func_sso_test_uat:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "uat"
      FEATURE_DIR: "sso"
      TAGS: "--tags=~@stage-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_sso_results,
    ]

  func_profile_test_uat:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "uat"
      FEATURE_DIR: "profile"
      TAGS: "--tags=~@stage-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_profile_results,
    ]

  func_international_test_uat:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "uat"
      FEATURE_DIR: "international"
      TAGS: "--tags=~@stage-only"
    <<: [
    *machine_python3_node_browsers,
    *steps_functional_tests_and_persist_international_results,
    ]

  delete_test_data_dev:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "dev"
    <<: [
    *machine_python3_node_browsers,
    *steps_delete_test_data,
    ]

  delete_test_data_stage:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "stage"
    <<: [
    *machine_python3_node_browsers,
    *steps_delete_test_data,
    ]

  delete_test_data_uat:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "uat"
    <<: [
    *machine_python3_node_browsers,
    *steps_delete_test_data,
    ]

  load_cms_tests_stage:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "cms"
      TEST_ENV: "stage"
      <<: [
      *load_hatch_rate,
      *load_num_users,
      *load_run_time,
      ]
    <<: [
    *machine_python3_node,
    *steps_run_load_tests,
    ]

  load_soo_tests_stage:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "soo"
      TEST_ENV: "stage"
      <<: [
      *load_hatch_rate,
      *load_num_users,
      *load_run_time,
      ]
    <<: [
    *machine_python3_node,
    *steps_run_load_tests,
    ]

  load_fab_tests_stage:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "fab"
      TEST_ENV: "stage"
      <<: [
      *load_hatch_rate,
      *load_num_users,
      *load_run_time,
      ]
    <<: [
    *machine_python3_node,
    *steps_run_load_tests,
    ]

  load_fas_tests_stage:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "fas"
      TEST_ENV: "stage"
      <<: [
      *load_hatch_rate,
      *load_num_users,
      *load_run_time,
      ]
    <<: [
    *machine_python3_node,
    *steps_run_load_tests,
    ]

  load_isd_tests_stage:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "isd"
      TEST_ENV: "stage"
      <<: [
      *load_hatch_rate,
      *load_num_users,
      *load_run_time,
      ]
    <<: [
    *machine_python3_node,
    *steps_run_load_tests,
    ]

  load_international_tests_stage:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "international"
      TEST_ENV: "stage"
      <<: [
      *load_hatch_rate,
      *load_num_users,
      *load_run_time,
      ]
    <<: [
    *machine_python3_node,
    *steps_run_load_tests,
    ]

  load_invest_tests_stage:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "invest"
      TEST_ENV: "stage"
      <<: [
      *load_hatch_rate,
      *load_num_users,
      *load_run_time,
      ]
    <<: [
    *machine_python3_node,
    *steps_run_load_tests,
    ]

  load_domestic_tests_stage:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "domestic"
      TEST_ENV: "stage"
      <<: [
      *load_hatch_rate,
      *load_num_users,
      *load_run_time,
      ]
    <<: [
    *machine_python3_node,
    *steps_run_load_tests,
    ]

  load_erp_tests_stage:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "erp"
      TEST_ENV: "stage"
      <<: [
      *load_hatch_rate,
      *load_num_users,
      *load_run_time,
      ]
    <<: [
    *machine_python3_node,
    *steps_run_load_tests,
    ]

  load_profile_tests_stage:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "profile"
      TEST_ENV: "stage"
      <<: [
      *load_hatch_rate,
      *load_num_users,
      *load_run_time,
      ]
    <<: [
    *machine_python3_node,
    *steps_run_load_tests,
    ]

  dev_parallel_browser_tests_using_circleci:
    working_directory: ~/directory-tests
    parallelism: 12
    environment:
      TEST_ENV: "dev"
      AUTO_RETRY: "true"
      TAKE_SCREENSHOTS: "true"
      TAGS: "--tags=~@stage-only --tags=~@uat-only --tags=~@erp"
      BROWSER_ENVIRONMENT: "local"
      BROWSER_HEADLESS: "true"
    <<: [
    *machine_python3_node_browsers,
    *steps_run_parallel_browser_tests,
    ]

  stage_parallel_browser_tests_using_circleci:
    working_directory: ~/directory-tests
    parallelism: 12
    environment:
      TEST_ENV: "stage"
      AUTO_RETRY: "true"
      TAKE_SCREENSHOTS: "true"
      TAGS: "--tags=~@dev-only --tags=~@uat-only --tags=~@erp"
      BROWSER_ENVIRONMENT: "local"
      BROWSER_HEADLESS: "true"
    <<: [
    *machine_python3_node_browsers,
    *steps_run_parallel_browser_tests,
    ]

  uat_parallel_browser_tests_using_circleci:
    working_directory: ~/directory-tests
    parallelism: 12
    environment:
      TEST_ENV: "uat"
      AUTO_RETRY: "true"
      TAKE_SCREENSHOTS: "true"
      TAGS: "--tags=~@stage-only --tags=~@erp"
      BROWSER_ENVIRONMENT: "local"
      BROWSER_HEADLESS: "true"
    <<: [
    *machine_python3_node_browsers,
    *steps_run_parallel_browser_tests,
    ]

  merge_browser_allure_results_and_generate_report_and_send_link_to_slack:
    working_directory: ~/directory-tests
    <<: [
    *machine_python3_node_browsers,
    *steps_merge_browser_allure_results_and_generate_report_and_send_link_to_slack,
    ]

  generate_allure_report_from_functional_tests_and_send_link_to_slack:
    working_directory: ~/directory-tests
    <<: [
    *machine_python3_node_browsers,
    *steps_generate_allure_report_from_functional_tests_and_send_link_to_slack,
    ]

  merge_junit_results_from_parallel_browser_tests:
    docker:
      - image: circleci/python:3.8.0-node-browsers
    working_directory: ~/directory-tests
    steps:
      - *step_install_junit_merge
      - checkout
      - attach_workspace:
          at: ./
      - *step_merge_junit_xml_reports_from_parallel_browser_tests
      - store_test_results:
          path: ./tests/browser/junit_report/
      - store_artifacts:
          path: ./tests/browser/junit_report/
          destination: junit_report

  store_behave_logs_from_browser_tests_as_artifacts:
    <<: *machine_python3_clean
    working_directory: ~/directory-tests
    steps:
      - attach_workspace:
          at: ./
      - store_artifacts:
          path: ./tests/browser/reports/
          destination: behave_logs

  setup_env_for_periodic_tasks: &setup_env_for_periodic_tasks
    working_directory: ~/directory-tests
    <<: [
    *machine_python3_clean,
    *steps_setup_env_for_periodic_tasks,
    ]

  refresh_geckoboard:
    working_directory: ~/directory-tests
    <<: [
    *machine_python3_clean,
    *steps_geckoboard_updater,
    ]

  check_for_dead_links_on_dev:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "DEV"
    <<: [
    *machine_python3_clean,
    *steps_dead_links_checker,
    ]

  check_for_dead_links_on_stage:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "STAGE"
    <<: [
    *machine_python3_clean,
    *steps_dead_links_checker,
    ]

  check_for_dead_links_on_uat:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "UAT"
    <<: [
    *machine_python3_clean,
    *steps_dead_links_checker,
    ]

  check_for_dead_links_on_prod:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "PROD"
    <<: [
    *machine_python3_clean,
    *steps_dead_links_checker,
    ]

  check_cms_pages_on_production_return_200:
    working_directory: ~/directory-tests
    <<: [
    *machine_python3_clean,
    *steps_run_test_cms_pages_return_200,
    ]

  generate_cms_page_status_report_for_prod:
    working_directory: ~/directory-tests
    environment:
      TEST_ENV: "PROD"
    <<: [
    *machine_python3_clean,
    *steps_generate_cms_page_status_report,
    ]

  domestic_compare_prod_and_dev_pages:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "domestic"
      ENVS_TO_COMPARE: "prod_dev"
    <<: [
    *machine_python3_clean,
    *steps_content_diff,
    ]

  domestic_compare_prod_and_stage_pages:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "domestic"
      ENVS_TO_COMPARE: "prod_stage"
    <<: [
    *machine_python3_clean,
    *steps_content_diff,
    ]

  domestic_compare_prod_and_uat_pages:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "domestic"
      ENVS_TO_COMPARE: "prod_uat"
    <<: [
    *machine_python3_clean,
    *steps_content_diff,
    ]

  domestic_compare_stage_and_dev_pages:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "domestic"
      ENVS_TO_COMPARE: "stage_dev"
    <<: [
    *machine_python3_clean,
    *steps_content_diff,
    ]

  domestic_compare_stage_and_uat_pages:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "domestic"
      ENVS_TO_COMPARE: "stage_uat"
    <<: [
    *machine_python3_clean,
    *steps_content_diff,
    ]

  international_compare_prod_and_stage_pages:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "international"
      ENVS_TO_COMPARE: "prod_stage"
    <<: [
    *machine_python3_clean,
    *steps_content_diff,
    ]

  international_compare_prod_and_uat_pages:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "international"
      ENVS_TO_COMPARE: "prod_uat"
    <<: [
    *machine_python3_clean,
    *steps_content_diff,
    ]

  international_compare_stage_and_uat_pages:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "international"
      ENVS_TO_COMPARE: "stage_uat"
    <<: [
    *machine_python3_clean,
    *steps_content_diff,
    ]

  international_compare_stage_and_dev_pages:
    working_directory: ~/directory-tests
    environment:
      SERVICE: "international"
      ENVS_TO_COMPARE: "stage_dev"
    <<: [
    *machine_python3_clean,
    *steps_content_diff,
    ]


workflows:
  version: 2

  ####################################################################
  ## Ad hoc workflows - these are run every time you push a change
  ####################################################################

  run_smoke_and_functional_tests_on_dev_ad_hoc:
    jobs:
      - setup_env_for_smoke_tests
      - setup_env_for_functional_tests
      - delete_test_data_dev:
          requires:
            - setup_env_for_functional_tests
      - smoke_tests_dev:
          requires:
            - setup_env_for_smoke_tests
      - func_fas_test_dev:
          requires:
            - delete_test_data_dev
      - func_international_test_dev:
          requires:
            - delete_test_data_dev
      - func_sso_test_dev:
          requires:
            - delete_test_data_dev
      - func_profile_test_dev:
          requires:
            - delete_test_data_dev
      - generate_allure_report_from_functional_tests_and_send_link_to_slack:
          requires:
            - func_fas_test_dev
            - func_sso_test_dev
            - func_profile_test_dev
            - func_international_test_dev

  run_browser_tests_in_parallel_in_dev_ad_hoc:
    jobs:
      - setup_env_for_parallel_browser_tests_using_circleci
      - dev_parallel_browser_tests_using_circleci:
          requires:
            - setup_env_for_parallel_browser_tests_using_circleci
      - merge_browser_allure_results_and_generate_report_and_send_link_to_slack:
          requires:
            - dev_parallel_browser_tests_using_circleci
      - merge_junit_results_from_parallel_browser_tests:
          requires:
            - dev_parallel_browser_tests_using_circleci
      - store_behave_logs_from_browser_tests_as_artifacts:
          requires:
            - dev_parallel_browser_tests_using_circleci

  run_smoke_and_functional_on_stage_ad_hoc:
    jobs:
      - setup_env_for_smoke_tests
      - setup_env_for_functional_tests
      - delete_test_data_stage:
          requires:
            - setup_env_for_functional_tests
      - smoke_tests_stage:
          requires:
            - setup_env_for_smoke_tests
      - func_fas_test_stage:
          requires:
            - delete_test_data_stage
      - func_international_test_stage:
          requires:
            - delete_test_data_stage
      - func_sso_test_stage:
          requires:
            - delete_test_data_stage
      - func_profile_test_stage:
          requires:
            - delete_test_data_stage
      - generate_allure_report_from_functional_tests_and_send_link_to_slack:
          requires:
            - func_fas_test_stage
            - func_sso_test_stage
            - func_profile_test_stage
            - func_international_test_stage

  run_browser_tests_in_parallel_in_stage_ad_hoc:
    jobs:
      - setup_env_for_parallel_browser_tests_using_circleci
      - stage_parallel_browser_tests_using_circleci:
          requires:
            - setup_env_for_parallel_browser_tests_using_circleci
      - merge_browser_allure_results_and_generate_report_and_send_link_to_slack:
          requires:
            - stage_parallel_browser_tests_using_circleci
      - merge_junit_results_from_parallel_browser_tests:
          requires:
            - stage_parallel_browser_tests_using_circleci
      - store_behave_logs_from_browser_tests_as_artifacts:
          requires:
            - stage_parallel_browser_tests_using_circleci

  run_smoke_and_functional_on_uat_ad_hoc:
    jobs:
      - setup_env_for_smoke_tests
      - setup_env_for_functional_tests
      - delete_test_data_uat:
          requires:
            - setup_env_for_functional_tests
      - smoke_tests_uat:
          requires:
            - setup_env_for_smoke_tests
      - func_fas_test_uat:
          requires:
            - delete_test_data_uat
      - func_international_test_uat:
          requires:
            - delete_test_data_uat
      - func_sso_test_uat:
          requires:
            - delete_test_data_uat
      - func_profile_test_uat:
          requires:
            - delete_test_data_uat
      - generate_allure_report_from_functional_tests_and_send_link_to_slack:
          requires:
            - func_fas_test_uat
            - func_sso_test_uat
            - func_profile_test_uat
            - func_international_test_uat

  run_browser_tests_in_parallel_in_uat_ad_hoc:
    jobs:
      - setup_env_for_parallel_browser_tests_using_circleci
      - uat_parallel_browser_tests_using_circleci:
          requires:
            - setup_env_for_parallel_browser_tests_using_circleci
      - merge_browser_allure_results_and_generate_report_and_send_link_to_slack:
          requires:
            - uat_parallel_browser_tests_using_circleci
      - merge_junit_results_from_parallel_browser_tests:
          requires:
            - uat_parallel_browser_tests_using_circleci
      - store_behave_logs_from_browser_tests_as_artifacts:
          requires:
            - uat_parallel_browser_tests_using_circleci

  prod_check_for_dead_links_ad_hoc:
    jobs:
      - setup_env_for_periodic_tasks
      - check_for_dead_links_on_prod:
          requires:
            - setup_env_for_periodic_tasks

  uat_check_for_dead_links_ad_hoc:
    jobs:
      - setup_env_for_periodic_tasks
      - check_for_dead_links_on_uat:
          requires:
            - setup_env_for_periodic_tasks

  stage_check_for_dead_links_ad_hoc:
    jobs:
      - setup_env_for_periodic_tasks
      - check_for_dead_links_on_stage:
          requires:
            - setup_env_for_periodic_tasks

  dev_check_for_dead_links_ad_hoc:
    jobs:
      - setup_env_for_periodic_tasks
      - check_for_dead_links_on_dev:
          requires:
            - setup_env_for_periodic_tasks

  refresh_geckoboard_ad_hoc:
    jobs:
      - setup_env_for_periodic_tasks
      - refresh_geckoboard:
          requires:
            - setup_env_for_periodic_tasks


  ####################################################################
  ## Scheduled workflows
  ####################################################################

  run_smoke_and_functional_tests_on_dev:
    triggers:
      - schedule:
          cron: "7 1 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_smoke_tests
      - setup_env_for_functional_tests
      - delete_test_data_dev:
          requires:
            - setup_env_for_functional_tests
      - smoke_tests_dev:
          requires:
            - setup_env_for_smoke_tests
      - func_fas_test_dev:
          requires:
            - delete_test_data_dev
      - func_international_test_dev:
          requires:
            - delete_test_data_dev
      - func_sso_test_dev:
          requires:
            - delete_test_data_dev
      - func_profile_test_dev:
          requires:
            - delete_test_data_dev
      - generate_allure_report_from_functional_tests_and_send_link_to_slack:
          requires:
            - func_fas_test_dev
            - func_sso_test_dev
            - func_profile_test_dev
            - func_international_test_dev

  run_browser_tests_in_parallel_in_dev:
    triggers:
      - schedule:
          cron: "39 1 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_parallel_browser_tests_using_circleci
      - dev_parallel_browser_tests_using_circleci:
          requires:
            - setup_env_for_parallel_browser_tests_using_circleci
      - merge_browser_allure_results_and_generate_report_and_send_link_to_slack:
          requires:
            - dev_parallel_browser_tests_using_circleci
      - merge_junit_results_from_parallel_browser_tests:
          requires:
            - dev_parallel_browser_tests_using_circleci
      - store_behave_logs_from_browser_tests_as_artifacts:
          requires:
            - dev_parallel_browser_tests_using_circleci

  run_smoke_and_functional_tests_on_stage:
    triggers:
      - schedule:
          cron: "52 2 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_smoke_tests
      - setup_env_for_functional_tests
      - delete_test_data_stage:
          requires:
            - setup_env_for_functional_tests
      - smoke_tests_stage:
          requires:
            - setup_env_for_smoke_tests
      - func_fas_test_stage:
          requires:
            - delete_test_data_stage
      - func_international_test_stage:
          requires:
            - delete_test_data_stage
      - func_sso_test_stage:
          requires:
            - delete_test_data_stage
      - func_profile_test_stage:
          requires:
            - delete_test_data_stage
      - generate_allure_report_from_functional_tests_and_send_link_to_slack:
          requires:
            - func_fas_test_stage
            - func_sso_test_stage
            - func_profile_test_stage
            - func_international_test_stage

  run_browser_tests_in_parallel_in_stage:
    triggers:
      - schedule:
          cron: "23 3 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_parallel_browser_tests_using_circleci
      - stage_parallel_browser_tests_using_circleci:
          requires:
            - setup_env_for_parallel_browser_tests_using_circleci
      - merge_browser_allure_results_and_generate_report_and_send_link_to_slack:
          requires:
            - stage_parallel_browser_tests_using_circleci
      - merge_junit_results_from_parallel_browser_tests:
          requires:
            - stage_parallel_browser_tests_using_circleci
      - store_behave_logs_from_browser_tests_as_artifacts:
          requires:
            - stage_parallel_browser_tests_using_circleci

  run_cms_load_tests_on_stage:
    triggers:
    - schedule:
        cron: "53 3 * * 1-5"
        filters:
          branches:
            only: master
    jobs:
    - setup_env_for_load_tests
    - load_cms_tests_stage:
        requires:
        - setup_env_for_load_tests

  run_fas_load_tests_on_stage:
    triggers:
    - schedule:
        cron: "4 4 * * 1-5"
        filters:
          branches:
            only: master
    jobs:
    - setup_env_for_load_tests
    - load_fas_tests_stage:
        requires:
        - setup_env_for_load_tests

  run_isd_load_tests_on_stage:
    triggers:
      - schedule:
          cron: "16 4 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_load_tests
      - load_isd_tests_stage:
          requires:
            - setup_env_for_load_tests

  run_international_load_tests_on_stage:
    triggers:
      - schedule:
          cron: "27 4 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_load_tests
      - load_international_tests_stage:
          requires:
            - setup_env_for_load_tests

  run_invest_load_tests_on_stage:
    triggers:
    - schedule:
        cron: "38 4 * * 1-5"
        filters:
          branches:
            only: master
    jobs:
    - setup_env_for_load_tests
    - load_invest_tests_stage:
        requires:
        - setup_env_for_load_tests

  run_fab_load_tests_on_stage:
    triggers:
    - schedule:
        cron: "49 4 * * 1-5"
        filters:
          branches:
            only: master
    jobs:
    - setup_env_for_load_tests
    - load_fab_tests_stage:
        requires:
        - setup_env_for_load_tests

  run_soo_load_tests_on_stage:
    triggers:
      - schedule:
          cron: "59 4 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_load_tests
      - load_soo_tests_stage:
          requires:
            - setup_env_for_load_tests

  run_domestic_load_tests_on_stage:
    triggers:
      - schedule:
          cron: "11 5 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_load_tests
      - load_domestic_tests_stage:
          requires:
            - setup_env_for_load_tests

  run_erp_load_tests_on_stage:
    triggers:
      - schedule:
          cron: "23 5 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_load_tests
      - load_erp_tests_stage:
          requires:
            - setup_env_for_load_tests

  run_profile_load_tests_on_stage:
    triggers:
      - schedule:
          cron: "23 5 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_load_tests
      - load_profile_tests_stage:
          requires:
            - setup_env_for_load_tests

  run_smoke_and_functional_tests_on_uat:
    triggers:
      - schedule:
          cron: "33 5 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_smoke_tests
      - setup_env_for_functional_tests
      - delete_test_data_uat:
          requires:
            - setup_env_for_functional_tests
      - smoke_tests_uat:
          requires:
            - setup_env_for_smoke_tests
      - func_fas_test_uat:
          requires:
            - delete_test_data_uat
      - func_international_test_uat:
          requires:
            - delete_test_data_uat
      - func_sso_test_uat:
          requires:
            - delete_test_data_uat
      - func_profile_test_uat:
          requires:
            - delete_test_data_uat
      - generate_allure_report_from_functional_tests_and_send_link_to_slack:
          requires:
            - func_fas_test_uat
            - func_sso_test_uat
            - func_profile_test_uat
            - func_international_test_uat

  run_browser_tests_in_parallel_in_uat:
    triggers:
      - schedule:
          cron: "3 6 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_parallel_browser_tests_using_circleci
      - uat_parallel_browser_tests_using_circleci:
          requires:
            - setup_env_for_parallel_browser_tests_using_circleci
      - merge_browser_allure_results_and_generate_report_and_send_link_to_slack:
          requires:
            - uat_parallel_browser_tests_using_circleci
      - merge_junit_results_from_parallel_browser_tests:
          requires:
            - uat_parallel_browser_tests_using_circleci
      - store_behave_logs_from_browser_tests_as_artifacts:
          requires:
            - uat_parallel_browser_tests_using_circleci

  refresh_geckoboard_periodically:
    triggers:
      - schedule:
          cron: "0 8,13 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - refresh_geckoboard

  prod_check_for_dead_links:
    triggers:
      - schedule:
          cron: "43 6 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - check_for_dead_links_on_prod:
          requires:
            - setup_env_for_periodic_tasks

  uat_check_for_dead_links:
    triggers:
      - schedule:
          cron: "53 6 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - check_for_dead_links_on_uat:
          requires:
            - setup_env_for_periodic_tasks

  stage_check_for_dead_links:
    triggers:
      - schedule:
          cron: "0 7 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - check_for_dead_links_on_stage:
          requires:
            - setup_env_for_periodic_tasks

  dev_check_for_dead_links:
    triggers:
      - schedule:
          cron: "10 7 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - check_for_dead_links_on_dev:
          requires:
            - setup_env_for_periodic_tasks

  prod_check_cms_peges_return_200:
    triggers:
      - schedule:
          cron: "17 7 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - check_cms_pages_on_production_return_200:
          requires:
            - setup_env_for_periodic_tasks

  domestic_prod_dev_content_diff:
    triggers:
      - schedule:
          cron: "28 7 * * 3"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - domestic_compare_prod_and_dev_pages:
          requires:
            - setup_env_for_periodic_tasks

  domestic_prod_uat_content_diff:
    triggers:
      - schedule:
          cron: "40 7 * * 3"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - domestic_compare_prod_and_uat_pages:
          requires:
            - setup_env_for_periodic_tasks

  domestic_prod_stage_content_diff:
    triggers:
      - schedule:
          cron: "51 7 * * 3"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - domestic_compare_prod_and_stage_pages:
          requires:
            - setup_env_for_periodic_tasks

  domestic_stage_uat_content_diff:
    triggers:
      - schedule:
          cron: "7 8 * * 3"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - domestic_compare_stage_and_uat_pages:
          requires:
            - setup_env_for_periodic_tasks

  domestic_stage_dev_content_diff:
    triggers:
      - schedule:
          cron: "21 8 * * 3"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - domestic_compare_stage_and_dev_pages:
          requires:
            - setup_env_for_periodic_tasks

  international_prod_stage_content_diff:
    triggers:
      - schedule:
          cron: "34 8 * * 3"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - international_compare_prod_and_stage_pages:
          requires:
            - setup_env_for_periodic_tasks

  international_prod_uat_content_diff:
    triggers:
      - schedule:
          cron: "52 8 * * 3"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - international_compare_prod_and_uat_pages:
          requires:
            - setup_env_for_periodic_tasks

  international_stage_uat_content_diff:
    triggers:
      - schedule:
          cron: "17 9 * * 3"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - international_compare_stage_and_uat_pages:
          requires:
            - setup_env_for_periodic_tasks

  international_stage_dev_content_diff:
    triggers:
      - schedule:
          cron: "33 9 * * 3"
          filters:
            branches:
              only: master
    jobs:
      - setup_env_for_periodic_tasks
      - international_compare_stage_and_dev_pages:
          requires:
            - setup_env_for_periodic_tasks

  prod_cms_page_status_report:
    triggers:
      - schedule:
          cron: "42 14 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - generate_cms_page_status_report_for_prod
